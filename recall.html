<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recall Your Application</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for modal */
        #message-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #message-modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- This div is required by Firebase for the invisible reCAPTCHA -->
    <div id="recaptcha-container"></div>

    <!-- Main Container -->
    <div class="container mx-auto max-w-md p-4 sm:p-6 lg:p-8 min-h-screen flex items-center justify-center">
        
        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full">
            <div class="p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Recall Your Application</h2>

                <!-- ====== Step 1: Lookup Form ====== -->
                <form id="lookup-form" class="space-y-4">
                    <p class="text-sm text-gray-600">Enter your details exactly as they appear on your application to find and resume your session.</p>
                    <div>
                        <label for="recall-first-name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="recall-first-name" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="recall-last-name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="recall-last-name" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="recall-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="recall-phone" placeholder="(555) 555-5555" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="lookup-error" class="text-sm text-red-600 hidden"></div>

                    <button type="submit" id="lookup-button" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                        Find My Application
                    </button>
                </form>

                <!-- ====== Step 2: OTP Form ====== -->
                <form id="otp-form" class="space-y-4 hidden">
                    <p id="otp-message" class="text-sm text-gray-600">We sent a 6-digit code to your phone. Please enter it below.</p>
                    <div>
                        <label for="otp-code" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
                        <input type="text" id="otp-code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg tracking-widest">
                    </div>

                    <div id="otp-error" class="text-sm text-red-600 hidden"></div>

                    <button type="submit" id="otp-button" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                        Verify Code
                    </button>
                </form>

            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0" onclick="hideModal()">
        <div id="message-modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-lg font-medium leading-6 text-gray-900"></h3>
            <div class="mt-2">
                <p id="modal-message" class="text-sm text-gray-500"></p>
            </div>
            <div class="mt-4">
                <button id="modal-ok-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="hideModal()">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase (v9 Compat) Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyBD2Zd4qjZCdqf3B2Gd13xjooTicvc-tXY", // Taken from your other files
            authDomain: "truckerapp-system.firebaseapp.com",
            projectId: "truckerapp-system",
            storageBucket: "truckerapp-system.firebasestorage.app",
            messagingSenderId: "725898258453",
            appId: "1:725898258453:web:5a5f0490e7baf3e518061c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log("Firebase App initialized for Recall page.");

        // === Global Variables ===
        window.confirmationResult = null;
        window.recaptchaVerifier = null;
        let originalLookupButtonText = "Find My Application";
        let originalOtpButtonText = "Verify Code";

        // === DOM Elements ===
        const lookupForm = document.getElementById('lookup-form');
        const otpForm = document.getElementById('otp-form');
        const lookupButton = document.getElementById('lookup-button');
        const otpButton = document.getElementById('otp-button');
        const lookupError = document.getElementById('lookup-error');
        const otpError = document.getElementById('otp-error');
        const otpMessage = document.getElementById('otp-message');

        // Modal Elements
        const modal = document.getElementById('message-modal');
        const modalContent = document.getElementById('message-modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok-button');

        // === Modal Functions ===
        function showModal(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Toggle colors based on error state
            modalOkButton.classList.toggle('bg-blue-600', !isError);
            modalOkButton.classList.toggle('hover:bg-blue-700', !isError);
            modalOkButton.classList.toggle('focus:ring-blue-500', !isError);
            modalOkButton.classList.toggle('bg-red-600', isError);
            modalOkButton.classList.toggle('hover:bg-red-700', isError);
            modalOkButton.classList.toggle('focus:ring-red-500', isError);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10); // Start transition
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Wait for transition to finish
        }

        // === Helper: Show Loading State ===
        function showLoading(button, text = "Loading...") {
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
            button.textContent = text;
        }

        // === Helper: Hide Loading State ===
        function hideLoading(button, originalText) {
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
            button.textContent = originalText;
        }

        // === Initialize reCAPTCHA ===
        window.onload = () => {
            try {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        // reCAPTCHA solved, allow signInWithPhoneNumber.
                        console.log('reCAPTCHA verified');
                    },
                    'expired-callback': () => {
                        // Response expired. Ask user to solve reCAPTCHA again.
                        console.log('reCAPTCHA expired, please try again.');
                    }
                });
                
                // Render the verifier
                window.recaptchaVerifier.render().then((widgetId) => {
                    console.log('reCAPTCHA rendered, widget ID:', widgetId);
                    window.recaptchaWidgetId = widgetId;
                }).catch(err => {
                    console.error("reCAPTCHA render error:", err);
                    lookupError.textContent = "Could not initialize security check. Please refresh the page.";
                    lookupError.classList.remove('hidden');
                });
            } catch (err) {
                console.error("Error creating reCAPTCHA verifier:", err);
                lookupError.textContent = "Failed to load security component. Please ensure you're not blocking reCAPTCHA.";
                lookupError.classList.remove('hidden');
            }
        };

        // === Step 1: Lookup Form Submit ===
        lookupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(lookupButton, "Searching...");
            lookupError.classList.add('hidden');

            const firstName = document.getElementById('recall-first-name').value.trim();
            const lastName = document.getElementById('recall-last-name').value.trim();
            const rawPhone = document.getElementById('recall-phone').value;

            if (!firstName || !lastName || !rawPhone) {
                lookupError.textContent = "All fields are required.";
                lookupError.classList.remove('hidden');
                hideLoading(lookupButton, originalLookupButtonText);
                return;
            }

            try {
                // 1. Query Firestore to find a matching application
                const q = db.collection("applications")
                    .where("first-name", "==", firstName)
                    .where("last-name", "==", lastName)
                    .where("phone", "==", rawPhone);

                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    // No match found
                    lookupError.textContent = "No application found with these details. Please check your inputs and try again.";
                    lookupError.classList.remove('hidden');
                    hideLoading(lookupButton, originalLookupButtonText);
                } else {
                    // Match found!
                    console.log("Application found:", querySnapshot.docs[0].id);
                    
                    // 2. Convert phone to E.164 format for Firebase Auth (assuming US numbers)
                    const e164Phone = `+1${rawPhone.replace(/[^0-9]/g, '')}`;
                    
                    // 3. Send OTP
                    const appVerifier = window.recaptchaVerifier;
                    auth.signInWithPhoneNumber(e164Phone, appVerifier)
                        .then((confirmationResult) => {
                            // SMS sent. Save confirmation result to global var
                            window.confirmationResult = confirmationResult;
                            console.log("OTP sent, confirmationResult stored.");
                            
                            // 4. Switch to OTP form
                            lookupForm.classList.add('hidden');
                            otpMessage.textContent = `We sent a 6-digit code to ${e164Phone}. Please enter it below.`;
                            otpForm.classList.remove('hidden');
                        })
                        .catch((error) => {
                            // Error sending OTP
                            console.error("Error sending OTP:", error);
                            if (error.code === 'auth/invalid-phone-number') {
                                lookupError.textContent = "The phone number is not valid.";
                            } else if (error.code === 'auth/too-many-requests') {
                                lookupError.textContent = "Too many requests. Please try again later.";
                            } else {
                                lookupError.textContent = "Could not send verification code. Please try again.";
                            }
                            lookupError.classList.remove('hidden');
                            
                            // Reset reCAPTCHA if it exists
                            if(window.recaptchaVerifier && typeof window.recaptchaVerifier.reset === 'function') {
                                window.recaptchaVerifier.reset(window.recaptchaWidgetId);
                            }
                        })
                        .finally(() => {
                            hideLoading(lookupButton, originalLookupButtonText);
                        });
                }
            } catch (error) {
                console.error("Error querying Firestore:", error);
                lookupError.textContent = "A database error occurred. Please try again later.";
                lookupError.classList.remove('hidden');
                hideLoading(lookupButton, originalLookupButtonText);
            }
        });

        // === Step 2: OTP Form Submit ===
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(otpButton, "Verifying...");
            otpError.classList.add('hidden');

            const code = document.getElementById('otp-code').value;

            if (code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
                otpError.textContent = "Please enter a 6-digit code.";
                otpError.classList.remove('hidden');
                hideLoading(otpButton, originalOtpButtonText);
                return;
            }

            if (!window.confirmationResult) {
                otpError.textContent = "Verification session expired. Please start over.";
                otpError.classList.remove('hidden');
                hideLoading(otpButton, originalOtpButtonText);
                // Optionally hide OTP form and show lookup form
                // otpForm.classList.add('hidden');
                // lookupForm.classList.remove('hidden');
                return;
            }

            try {
                // 1. Confirm the code
                const result = await window.confirmationResult.confirm(code);
                
                // 2. User is verified!
                const user = result.user;
                console.log("User verified!", user.uid);
                
                // 3. Show success and prepare for redirect
                showModal("Success!", "You have been successfully verified. We will now load your application.");
                
                // TODO: Store the found application ID in session storage and redirect.
                // const appId = querySnapshot.docs[0].id; // (Need to pass this from step 1)
                // sessionStorage.setItem('recallAppId', appId);
                // window.location.href = '/application_form.html'; // Redirect to the form
                
                // For now, just reload the page after a delay
                setTimeout(() => {
                    hideModal();
                    location.reload(); 
                }, 3000);

            } catch (error) {
                // Error verifying code
                console.error("Error verifying code:", error);
                if (error.code === 'auth/invalid-verification-code') {
                    otpError.textContent = "Invalid code. Please try again.";
                } else if (error.code === 'auth/code-expired') {
                    otpError.textContent = "The code has expired. Please request a new one by starting over.";
                } else {
                    otpError.textContent = "Verification failed. Please try again.";
                }
                otpError.classList.remove('hidden');
                hideLoading(otpButton, originalOtpButtonText);
            }
        });

    </script>
</body>
</html>
